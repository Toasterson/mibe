#!/bin/bash
# 
# Tests Image Management on Joyent VMs using sdc* tools.

#set -o xtrace

usage() {
cat << EOF

Usage: $0 IMAGE VERSION

Arguments:
    
    IMAGE              Name of image to test
    VERSION            Version of image to test

EOF
exit 2;
}

shift $(($OPTIND - 1))
if [[ $# = 2 ]]; then
        IMAGE=$1;
        VERSION=$2;
else
        usage;
fi

if [[ $(sdc-listimages | json -aH id name version | grep "${IMAGE}" | grep "${VERSION}" &>/dev/null)$? -eq 0 ]]; then
	IMAGE_UUID=$(sdc-listimages | json -aH id name version | grep "${IMAGE}" | grep "${VERSION}" | awk '{ print $1 }');
	
	echo "* Creating vm from ${IMAGE} ${VERSION} (${IMAGE_UUID})..";
	sdc-createmachine --image="${IMAGE_UUID}" --name="custom-imgmgmtest" --package "Medium 2GB" &> /dev/null

	echo -ne "* Waiting for vm custom-imgmgmtest to finish provisioning..";
	while [[ $(sdc-listmachines | json -aH id name state | grep custom-imgmgmtest | awk '{ print $3 }') != "running" ]]; do
		echo -ne ".";
		sleep 15;
	done

	VM_UUID=$(sdc-listmachines | json -aH id name | grep custom-imgmgmtest | awk '{ print $1 }');

	echo -ne "\n* Creating custom image from vm custom-imgmgmtest (${VM_UUID})..\n";
	sdc-createimagefrommachine --machine="${VM_UUID}" --name="custom_imgmgmtest" --imageVersion="1.0.0" > /dev/null

	echo -ne "* Waiting for custom image custom_imgmgmtest to be active..";
	while [[ $(sdc-listimages | json -aH id name state | grep custom_imgmgmtest | awk '{ print $3 }') != "active" ]]; do
		echo -ne ".";
		sleep 15;
	done	

	CUSTOM_IMAGE_UUID=$(sdc-listimages | json -aH id name | grep custom_imgmgmtest | awk '{ print $1 }');

	echo -ne "\n* Creating custom VM from custom image custom_imgmgmtest (${CUSTOM_IMAGE_UUID})..\n";
	sdc-createmachine --image="${CUSTOM_IMAGE_UUID}" --name custom-vmimgmgmtest --package "Medium 2GB" &> /dev/null

	echo -ne "* Waiting for custom vm custom-vmimgmgmtest to provision IP..";
	while [[ $(sdc-listmachines | json -aH id name state primaryIp | grep custom-vmimgmgmtest | awk '{ print $4 }') = "" ]]; do
		echo -ne ".";
		sleep 15;
	done

	CUSTOM_VM_IP=$(sdc-listmachines | json -aH id name primaryIp | grep custom-vmimgmgmtest | awk '{ print $3 }');
	CUSTOM_VM_UUID=$(sdc-listmachines | json -aH id name | grep custom-vmimgmgmtest | awk '{ print $1 }');

	echo -ne "\n\n";

	cat <<- EOF
	Done! The custom vm IP is ${CUSTOM_VM_IP}

	When finished you'll need to clean up with:
	sdc-deletemachine ${CUSTOM_VM_UUID}
	sdc-deletemachine ${VM_UUID}
	sdc-deleteimage ${CUSTOM_IMAGE_UUID}
	sdc-deleteimage ${IMAGE_UUID}

	EOF

else
	echo "ERROR - That image doesn't exist in your images list.";
	exit 2;
fi
